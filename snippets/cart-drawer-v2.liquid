{% comment %}
  Renders cart drawer - V2 Custom Design
  Usage:
  {% render 'cart-drawer-v2' %}
{% endcomment %}

<script src="{{ 'cart.js' | asset_url }}" defer="defer"></script>
<script src="{{ 'cart-drawer.js' | asset_url }}" defer="defer"></script>

<style>
  /* Override default Dawn drawer styles to prevent conflicts */
  cart-drawer.drawer {
    background-color: transparent !important;
    visibility: visible !important; /* Let the children handle visibility */
    pointer-events: none; /* Allow clicks to pass through wrapper if needed, but children will re-enable */
  }
  
  cart-drawer.drawer.active {
    visibility: visible !important;
    pointer-events: auto;
  }

  .cart-drawer-v2 {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    max-width: 450px;
    height: 100%;
    background: #fff;
    z-index: 1001; /* Higher than overlay */
    transform: translateX(100%);
    transition: transform 0.3s cubic-bezier(0.165, 0.84, 0.44, 1);
    display: flex;
    flex-direction: column;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    box-shadow: -5px 0 15px rgba(0,0,0,0.1);
    visibility: hidden;
  }

  .drawer.active .cart-drawer-v2 {
    transform: translateX(0) !important;
    visibility: visible !important;
  }
  
  .cart-drawer__overlay {
    position: fixed;
    top: 0;
    right: 0;
    bottom: 0;
    left: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s ease, visibility 0.3s ease;
    cursor: pointer;
  }

  .drawer.active .cart-drawer__overlay {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  cart-drawer.is-empty .drawer__inner {
      display: grid;
      grid-template-rows: 1fr;
      align-items: center;
      padding: 0;
  }

  .drawer__header {
    padding: 15px 20px;
    display: flex;
    justify-content: center;
    align-items: center;
    position: relative;
    border-bottom: 1px solid #eee;
  }


  .drawer__heading {
    margin: 0;
    font-size: 16px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .drawer__close {
    position: absolute;
    right: 20px;
    background: #eee;
    border: none;
    cursor: pointer;
    padding: 8px;
    border-radius: 4px;
    line-height: 0;
  }
  
  .drawer__close svg {
    width: 12px;
    height: 12px;
  }

  .cart-drawer__timer {
    background-color: #F0F0FF;
    color: #4A4AFF;
    padding: 10px;
    margin: 15px 20px 0;
    border-radius: 8px;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
  }

  .cart-drawer-items {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }
  
  .cart-drawer__form {
    display: flex;
    flex-direction: column;
    flex: 1;
    height: 100%;
    overflow: hidden;
  }

  .cart-drawer__scroll-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
  }

  .cart-item-v2 {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #f5f5f5;
  }

  .cart-item-v2:last-child {
    border-bottom: none;
  }

  .cart-item__image-wrapper {
    width: 80px;
    flex-shrink: 0;
  }

  .cart-item__image {
    width: 100%;
    height: auto;
    border-radius: 8px;
    object-fit: cover;
    border: 1px solid #eee;
  }

  .cart-item__info {
    flex: 1;
  }

  .cart-item__title {
    font-size: 14px;
    font-weight: 600;
    line-height: 1.4;
    margin-bottom: 4px;
    display: block;
    text-decoration: none;
    color: #000;
  }

  .cart-item__variant {
    font-size: 12px;
    color: #666;
    margin-bottom: 4px;
  }

  .cart-item__price-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .cart-item__price {
    font-weight: 700;
    font-size: 14px;
  }

  .cart-item__price--compare {
    text-decoration: line-through;
    color: #999;
    font-size: 12px;
  }

  .cart-item__actions {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
  }

  .cart-item__quantity-selector {
    position: relative;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cart-item__quantity-text {
    border: 1px solid #ddd;
    border-radius: 4px;
    padding: 4px 12px;
    background: #f9f9f9;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    cursor: default;
  }

  .cart-item__remove {
    display: block;
    font-size: 11px;
    text-decoration: underline;
    color: #666;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
  }

  /* Free Items */
  .free-items-list {
    margin-top: -10px;
    margin-bottom: 20px;
    padding-left: 0;
  }

  .free-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 10px;
    padding-left: 10px;
  }

  .free-item__image {
    width: 30px;
    height: 30px;
    object-fit: contain;
  }

  .free-item__title {
    font-size: 12px;
    font-weight: 600;
    flex: 1;
  }

  .free-item__price {
    font-size: 12px;
    font-weight: 700;
    color: #5C5CFF;
    text-transform: uppercase;
  }

  /* Lighting Deal */
  .lighting-deal {
    margin: 0 20px 20px;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
  }

  .lighting-deal__header {
    background: linear-gradient(90deg, #6B46C1 0%, #805AD5 100%);
    color: white;
    text-align: center;
    padding: 8px;
    font-weight: 700;
    font-size: 14px;
    text-transform: uppercase;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 5px;
  }

  .lighting-deal__content {
    padding: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .lighting-deal__image {
    width: 60px;
    height: auto;
  }

  .lighting-deal__info {
    flex: 1;
  }

  .lighting-deal__title {
    font-size: 13px;
    font-weight: 700;
    margin-bottom: 4px;
    line-height: 1.3;
  }

  .lighting-deal__price {
    font-weight: 700;
    font-size: 14px;
  }
  
  .lighting-deal__price s {
    color: #999;
    font-weight: 400;
    font-size: 12px;
    margin-right: 5px;
  }

  .lighting-deal__btn {
    background: #5C5CFF;
    color: white;
    border: none;
    padding: 8px 12px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 700;
    cursor: pointer;
    text-transform: uppercase;
    white-space: nowrap;
  }

  /* Footer */
  .drawer__footer {
    padding: 20px;
    background: #fff;
    border-top: 1px solid #eee;
    box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
  }

  .cart-subtotal {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
    font-weight: 700;
    font-size: 16px;
  }

  .checkout-btn {
    width: 100%;
    background: #4C3BCF;
    color: white;
    border: none;
    padding: 16px;
    border-radius: 8px;
    font-size: 18px;
    font-weight: 700;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    text-transform: uppercase;
    text-decoration: none;
  }
  
  .checkout-btn:hover {
    background: #3c2eb5;
  }

  .trust-badges {
    margin-top: 15px;
    text-align: center;
    font-size: 12px;
    color: #333;
    display: flex;
    flex-direction: column;
    gap: 5px;
    align-items: center;
  }
  
  .trust-badges__stars {
    color: #4C3BCF;
    font-weight: bold;
  }
  
  .trust-badges__guarantee {
    display: flex;
    align-items: center;
    gap: 5px;
  }

  /* Empty State */
  .drawer__empty-content {
    text-align: center;
    padding: 40px 20px;
  }
  
  .drawer__empty-text {
    margin-bottom: 20px;
  }
  
  .button {
    display: inline-block;
    padding: 10px 20px;
    background: #000;
    color: #fff;
    text-decoration: none;
    border-radius: 4px;
  }

</style>

<cart-drawer class="cart-drawer drawer{% if cart == empty %} is-empty{% endif %}">
  <div id="CartDrawer" class="cart-drawer">
    <div id="CartDrawer-Overlay" class="cart-drawer__overlay"></div>
    <div class="drawer__inner cart-drawer-v2" role="dialog" aria-modal="true" aria-label="{{ 'sections.cart.title' | t }}" tabindex="-1">
      <!-- Header -->
      <div class="drawer__header">
        <h2 class="drawer__heading">Your Cart ({{ cart.item_count }})</h2>
        <button class="drawer__close" type="button" onclick="this.closest('cart-drawer').close()" aria-label="{{ 'accessibility.close' | t }}">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      </div>

      {%- if cart == empty -%}
        <div class="drawer__inner-empty">
          <div class="drawer__empty-content">
            <h2 class="drawer__empty-text">{{ 'sections.cart.empty' | t }}</h2>
            <button class="drawer__close" type="button" onclick="this.closest('cart-drawer').close()" aria-label="{{ 'accessibility.close' | t }}">
               Close
            </button>
            <a href="{{ routes.all_products_collection_url }}" class="button">
              {{ 'general.continue_shopping' | t }}
            </a>
          </div>
        </div>
      {%- else -%}
        
        <!-- Timer -->
        <div class="cart-drawer__timer">
          <span>ðŸ”¥</span>
          <span id="cart-timer">Your cart will expire in 10:00 minutes</span>
          <span>ðŸš¨</span>
        </div>

        <cart-drawer-items class="cart-drawer-items{% if cart == empty %} is-empty{% endif %}">
          <form action="{{ routes.cart_url }}" id="CartDrawer-Form" class="cart__contents cart-drawer__form" method="post">
            <div class="cart-drawer__scroll-area" id="CartDrawer-CartItems">
              
              {%- liquid
                assign free_product_ids = ""
                for item in cart.items
                  if item.product.metafields.custom.free_products.value != blank
                    for free_product in item.product.metafields.custom.free_products.value
                      assign free_product_ids = free_product_ids | append: free_product.id | append: ","
                    endfor
                  endif
                endfor
                assign free_product_ids_array = free_product_ids | split: ','
              -%}

              {%- for item in cart.items -%}
                {%- liquid
                  assign item_product_id_str = item.product.id | append: ''
                  if free_product_ids_array contains item_product_id_str
                    continue
                  endif
                -%}

                <div class="cart-item-v2" id="CartDrawer-Item-{{ item.index | plus: 1 }}">
                  <div class="cart-item__image-wrapper">
                    {% if item.image %}
                      <img class="cart-item__image" src="{{ item.image | image_url: width: 200 }}" alt="{{ item.image.alt | escape }}" loading="lazy" width="100" height="100">
                    {% endif %}
                  </div>
                  
                  <div class="cart-item__info">
                    <a href="{{ item.url }}" class="cart-item__title">{{ item.product.title | escape }}</a>
                    
                    {%- unless item.product.has_only_default_variant -%}
                      <div class="cart-item__variant">
                        {%- for option in item.options_with_values -%}
                          {{ option.value }}{% unless forloop.last %} / {% endunless %}
                        {%- endfor -%}
                      </div>
                    {%- endunless -%}
                    
                    {% if item.selling_plan_allocation %}
                      <div class="cart-item__variant">{{ item.selling_plan_allocation.selling_plan.name }}</div>
                    {% endif %}

                    <div class="cart-item__price-row">
                      <span class="cart-item__price">{{ item.final_price | money }}</span>
                      {% if item.original_price > item.final_price %}
                        <span class="cart-item__price--compare">{{ item.original_price | money }}</span>
                      {% endif %}
                    </div>
                  </div>

                  <div class="cart-item__actions">
                    <div class="cart-item__quantity-selector">
                      <div class="cart-item__quantity-text">
                        Qty: {{ item.quantity }}
                      </div>
                      
                      <cart-remove-button id="CartDrawer-Remove-{{ item.index | plus: 1 }}" data-index="{{ item.index | plus: 1 }}">
                        <button type="button" class="cart-item__remove" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}">
                          Remove
                        </button>
                      </cart-remove-button>
                    </div>
                  </div>
                </div>

                <!-- Free Products for this item -->
                {%- if item.product.metafields.custom.free_products.value != blank -%}
                  <div class="free-items-list">
                    {%- for free_product in item.product.metafields.custom.free_products.value -%}
                      {%- assign is_in_cart = false -%}
                      {%- for cart_item in cart.items -%}
                        {%- if cart_item.product.id == free_product.id -%}
                          {%- assign is_in_cart = true -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}

                      {%- if is_in_cart -%}
                        <div class="free-item">
                          {% if free_product.featured_image %}
                            <img class="free-item__image" src="{{ free_product.featured_image | image_url: width: 60 }}" alt="{{ free_product.title }}" loading="lazy" width="30" height="30">
                          {% endif %}
                          <span class="free-item__title">FREE {{ free_product.title }}</span>
                          <span class="free-item__price">FREE</span>
                        </div>
                      {%- endif -%}
                    {%- endfor -%}
                  </div>
                {%- endif -%}

              {%- endfor -%}

              <!-- Lighting Deal (Placeholder or Dynamic) -->
              {% assign upsell_product = all_products['90-servings-coffee'] %} 
              {% comment %} Try to find a product, or just show placeholder if not found {% endcomment %}
              
              <div class="lighting-deal">
                <div class="lighting-deal__header">
                  <span>âš¡ Lighting Deal! âš¡</span>
                </div>
                <div class="lighting-deal__content">
                  <img src="https://cdn.shopify.com/s/files/1/0663/6666/9095/files/placeholder-coffee.png?v=1" class="lighting-deal__image" alt="Deal" style="background:#eee;" width="60" height="60">
                  <div class="lighting-deal__info">
                    <div class="lighting-deal__title">90 Servings of Coffee + FREE Starter Kit</div>
                    <div class="lighting-deal__price"><s>$135.00</s> $69</div>
                  </div>
                  <button type="button" class="lighting-deal__btn">UPGRADE NOW</button>
                </div>
              </div>

            </div>
          </form>
        </cart-drawer-items>

        <!-- Footer -->
        <div class="drawer__footer cart-drawer__footer">
          <div class="cart-subtotal">
            <span>Subtotal:</span>
            <span>{{ cart.total_price | money }}</span>
          </div>
          
          <button type="submit" id="CartDrawer-Checkout" class="checkout-btn" name="checkout" form="CartDrawer-Form">
            CHECKOUT NOW
            <svg width="16" height="18" viewBox="0 0 16 18" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M13 6V4C13 2.89543 12.1046 2 11 2H5C3.89543 2 3 2.89543 3 4V6M1 6H15V16C15 16.5523 14.5523 17 14 17H2C1.44772 17 1 16.5523 1 16V6Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M8 11V13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>

          <div class="trust-badges">
            <div class="trust-badges__stars">
              4.8 â˜…â˜…â˜…â˜…â˜… 300,000+ Happy Customers
            </div>
            <div class="trust-badges__guarantee">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
              </svg>
              45-Day Satisfaction Guarantee
            </div>
          </div>
        </div>
      {%- endif -%}
    </div>
  </div>
</cart-drawer>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Timer Logic
    function startTimer(duration, display) {
      var timer = duration, minutes, seconds;
      var interval = setInterval(function () {
        minutes = parseInt(timer / 60, 10);
        seconds = parseInt(timer % 60, 10);

        minutes = minutes < 10 ? "0" + minutes : minutes;
        seconds = seconds < 10 ? "0" + seconds : seconds;

        display.textContent = "Your cart will expire in " + minutes + ":" + seconds + " minutes";

        if (--timer < 0) {
          timer = duration; // Reset or handle expiry
        }
      }, 1000);
    }

    var fiveMinutes = 60 * 10, // 10 minutes
        display = document.querySelector('#cart-timer');
    if(display) {
        startTimer(fiveMinutes, display);
    }

    // Fallback for close button if custom element method fails or isn't ready
    const closeBtns = document.querySelectorAll('.drawer__close');
    closeBtns.forEach(btn => {
      btn.addEventListener('click', function(e) {
        const drawer = this.closest('cart-drawer');
        if (drawer) {
           if (typeof drawer.close === 'function') {
             drawer.close();
           } else {
             drawer.classList.remove('active');
             document.body.classList.remove('overflow-hidden');
           }
        }
      });
    });
  });
</script>
